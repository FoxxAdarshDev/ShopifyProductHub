{% comment %}
  Shopify Product Tab Template - Automatically detects and creates tabs from product description HTML
  
  This template analyzes the product description HTML content and:
  1. Detects tab content sections by their IDs
  2. Creates corresponding tab navigation
  3. Handles active/inactive tab states
  4. Provides responsive styling
{% endcomment %}

{% assign product_description = product.description %}

{% comment %} Check if product has our template structure {% endcomment %}
{% assign has_container = false %}
{% assign has_tab_structure = false %}
{% assign has_data_sku = false %}

{% if product_description contains 'class="container"' %}
  {% assign has_container = true %}
{% endif %}

{% if product_description contains 'id="description"' or product_description contains 'id="features"' or product_description contains 'id="applications"' %}
  {% assign has_tab_structure = true %}
{% endif %}

{% if product_description contains 'data-sku=' %}
  {% assign has_data_sku = true %}
{% endif %}

{% assign is_template_structure = false %}
{% if has_container and has_tab_structure and has_data_sku %}
  {% assign is_template_structure = true %}
{% endif %}

{% comment %} Only render tabs if we detect our template structure {% endcomment %}
{% if is_template_structure %}

<style>
/* Product Tab Styles */
.halo-product-tabs {
  margin: 20px 0;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
}

.halo-tab-navigation {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-bottom: 20px;
  border-bottom: 2px solid #e5e7eb;
  padding-bottom: 0;
}

.halo-tab-button {
  background: none;
  border: none;
  padding: 12px 20px;
  cursor: pointer;
  border-radius: 6px 6px 0 0;
  font-size: 14px;
  font-weight: 500;
  color: #6b7280;
  text-transform: capitalize;
  transition: all 0.2s ease;
  position: relative;
  border-bottom: 3px solid transparent;
}

.halo-tab-button:hover {
  color: #374151;
  background-color: #f9fafb;
}

.halo-tab-button.active {
  color: #1f2937;
  background-color: #ffffff;
  border-bottom-color: #3b82f6;
  font-weight: 600;
}

.halo-tab-content {
  display: none;
  animation: fadeIn 0.3s ease-in-out;
}

.halo-tab-content.active {
  display: block;
}

.halo-tab-content-inner {
  padding: 20px 0;
  line-height: 1.6;
}

/* Content Styling */
.halo-tab-content h2 {
  font-size: 24px;
  font-weight: 600;
  margin-bottom: 16px;
  color: #1f2937;
}

.halo-tab-content h3 {
  font-size: 20px;
  font-weight: 600;
  margin-bottom: 12px;
  color: #374151;
}

.halo-tab-content h4 {
  font-size: 16px;
  font-weight: 600;
  margin-bottom: 8px;
  color: #374151;
}

.halo-tab-content p {
  margin-bottom: 16px;
  color: #4b5563;
}

.halo-tab-content ul {
  margin-bottom: 16px;
  padding-left: 20px;
}

.halo-tab-content li {
  margin-bottom: 8px;
  color: #4b5563;
}

.halo-tab-content table {
  width: 100%;
  border-collapse: collapse;
  margin-bottom: 16px;
}

.halo-tab-content table th,
.halo-tab-content table td {
  padding: 12px;
  text-align: left;
  border-bottom: 1px solid #e5e7eb;
}

.halo-tab-content table th {
  background-color: #f9fafb;
  font-weight: 600;
  color: #374151;
}

.halo-tab-content .logo-grid {
  display: flex;
  flex-wrap: wrap;
  gap: 16px;
  margin: 20px 0;
}

.halo-tab-content .logo-grid img {
  max-height: 60px;
  width: auto;
}

/* Compatible Container Styling */
.compatible-items-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 20px;
  margin-top: 20px;
}

.compatible-item {
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  padding: 16px;
  transition: shadow 0.2s ease;
}

.compatible-item:hover {
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
}

.compatible-item img {
  width: 100%;
  height: 150px;
  object-fit: cover;
  border-radius: 6px;
  margin-bottom: 12px;
}

.compatible-item-title {
  font-size: 16px;
  font-weight: 600;
  margin-bottom: 8px;
  color: #1f2937;
}

.compatible-item-description {
  font-size: 14px;
  color: #6b7280;
  margin-bottom: 12px;
}

.compatible-item-link {
  display: inline-block;
  color: #3b82f6;
  text-decoration: none;
  font-weight: 500;
  font-size: 14px;
}

.compatible-item-link:hover {
  text-decoration: underline;
}

/* Video responsive */
.halo-tab-content iframe {
  max-width: 100%;
  height: auto;
  aspect-ratio: 16/9;
}

/* Mobile responsive */
@media (max-width: 768px) {
  .halo-tab-navigation {
    flex-direction: column;
  }
  
  .halo-tab-button {
    text-align: left;
    border-radius: 6px;
    border-bottom: none;
    border-left: 3px solid transparent;
  }
  
  .halo-tab-button.active {
    border-left-color: #3b82f6;
    border-bottom: none;
  }
  
  .compatible-items-grid {
    grid-template-columns: 1fr;
  }
  
  .halo-tab-content iframe {
    width: 100%;
    height: 250px;
  }
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}
</style>

<div class="halo-product-tabs">
  {% comment %} Detect available tabs from the HTML content {% endcomment %}
  {% assign available_tabs = '' %}
  {% assign tab_titles = '' %}
  
  {% comment %} Define tab order and titles {% endcomment %}
  {% assign ordered_tabs = 'description,features,applications,specification,sterilization-method,compatible-container,documentation,videos' | split: ',' %}
  {% assign tab_display_names = 'Description,Features,Applications,Specifications,Sterilization Method,Compatible Container,Documentation,Videos' | split: ',' %}
  
  {% comment %} Check which tabs are present in the content {% endcomment %}
  {% assign found_tabs = '' %}
  {% assign found_titles = '' %}
  
  {% for tab in ordered_tabs %}
    {% assign tab_id = 'id="' | append: tab | append: '"' %}
    {% if product_description contains tab_id %}
      {% if found_tabs == '' %}
        {% assign found_tabs = tab %}
      {% else %}
        {% assign found_tabs = found_tabs | append: ',' | append: tab %}
      {% endif %}
      
      {% assign tab_index = forloop.index0 %}
      {% assign tab_title = tab_display_names[tab_index] %}
      {% if found_titles == '' %}
        {% assign found_titles = tab_title %}
      {% else %}
        {% assign found_titles = found_titles | append: ',' | append: tab_title %}
      {% endif %}
    {% endif %}
  {% endfor %}
  
  {% assign available_tabs = found_tabs | split: ',' %}
  {% assign tab_titles = found_titles | split: ',' %}
  
  {% comment %} Only show tabs if we found any {% endcomment %}
  {% if available_tabs.size > 0 %}
    
    {% comment %} Tab Navigation {% endcomment %}
    <div class="halo-tab-navigation">
      {% for tab in available_tabs %}
        {% assign tab_title = tab_titles[forloop.index0] %}
        {% assign is_first = forloop.first %}
        <button class="halo-tab-button{% if is_first %} active{% endif %}" 
                onclick="haloSwitchTab(event, '{{ tab }}')" 
                data-tab="{{ tab }}">
          {{ tab_title }}
        </button>
      {% endfor %}
    </div>
    
    {% comment %} Tab Content {% endcomment %}
    <div class="halo-tab-content-container">
      {% for tab in available_tabs %}
        {% assign is_first = forloop.first %}
        <div id="halo-{{ tab }}" class="halo-tab-content{% if is_first %} active{% endif %}">
          <div class="halo-tab-content-inner">
            {% comment %} Extract and display the specific tab content {% endcomment %}
            {% assign tab_start = 'id="' | append: tab | append: '"' %}
            {% assign content_start = product_description | split: tab_start %}
            {% if content_start.size > 1 %}
              {% assign content_part = content_start[1] %}
              {% assign content_end = content_part | split: '<div class="tab-content"' %}
              {% assign tab_content = content_end[0] %}
              {% assign final_content = tab_content | split: '</div>' %}
              {% assign clean_content = final_content[0] %}
              
              {% comment %} Remove the opening > and any extra attributes {% endcomment %}
              {% assign content_parts = clean_content | split: '>' %}
              {% assign content_without_opening = '' %}
              {% for part in content_parts offset: 1 %}
                {% if content_without_opening == '' %}
                  {% assign content_without_opening = part %}
                {% else %}
                  {% assign content_without_opening = content_without_opening | append: '>' | append: part %}
                {% endif %}
              {% endfor %}
              
              {{ content_without_opening }}
            {% endif %}
          </div>
        </div>
      {% endfor %}
    </div>
    
    <script>
    function haloSwitchTab(event, tabId) {
      // Remove active class from all tab buttons
      var tabButtons = document.querySelectorAll('.halo-tab-button');
      tabButtons.forEach(function(button) {
        button.classList.remove('active');
      });
      
      // Add active class to clicked button
      event.target.classList.add('active');
      
      // Hide all tab content
      var tabContents = document.querySelectorAll('.halo-tab-content');
      tabContents.forEach(function(content) {
        content.classList.remove('active');
      });
      
      // Show selected tab content
      var activeTab = document.getElementById('halo-' + tabId);
      if (activeTab) {
        activeTab.classList.add('active');
      }
    }
    
    // Initialize tabs on page load
    document.addEventListener('DOMContentLoaded', function() {
      // Ensure first tab is active by default
      var firstButton = document.querySelector('.halo-tab-button');
      var firstContent = document.querySelector('.halo-tab-content');
      
      if (firstButton && firstContent) {
        firstButton.classList.add('active');
        firstContent.classList.add('active');
      }
    });
    </script>
    
  {% endif %}
  
{% else %}
  {% comment %} Fallback: Show original product description if no template structure detected {% endcomment %}
  <div class="product-description-fallback">
    {{ product.description }}
  </div>
{% endif %}

</div>